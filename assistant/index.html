<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Synapse</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.min.js"></script>
<link rel="stylesheet" href="./styles.css">
</head>
<body>

<!-- Sidebar overlay for mobile -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer" role="status" aria-live="polite" aria-relevant="additions text"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <button onclick="createConversation()" aria-label="New chat">+ New Chat</button>
    <button onclick="document.getElementById('charImportInput').click()" title="Import character card" aria-label="Import character card" style="flex:0 0 auto;padding:10px 12px">&#128101;</button>
    <button onclick="clearAllConversations()" title="Delete all conversations" aria-label="Delete all conversations" style="flex:0 0 auto;padding:10px 12px">&#128465;</button>
    <input type="file" id="charImportInput" accept=".png,.json" style="display:none" onchange="importCharacterCard(event)">
  </div>
  <div class="sidebar-search">
    <input type="text" id="sidebarSearch" placeholder="Search conversations..." oninput="filterConversations()">
    <button class="search-clear-btn" onclick="document.getElementById('sidebarSearch').value='';filterConversations()" aria-label="Clear search">&times;</button>
  </div>
  <button class="global-search-btn" onclick="openGlobalSearch()">&#128269; Search all messages</button>
  <div class="tag-filter-bar" id="tagFilterBar"></div>
  <div class="conv-list" id="convList"></div>
  <div class="sidebar-footer">
    made by <a href="https://platberlitz.github.io/" target="_blank">purachina</a> and 100% claude
    <span class="footer-cta">click for more stuff from me</span>
  </div>
</div>

<!-- Main Area -->
<div class="main">
  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="toolbar-toggle" onclick="toggleSidebar()" title="Toggle sidebar" aria-label="Toggle sidebar">&#9776;</button>
      <span class="toolbar-title">Synapse</span>
    </div>
    <div class="toolbar-right">
      <div class="toolbar-more">
        <button class="toolbar-btn" onclick="toggleToolbarMenu(event)" title="More actions" aria-label="More actions">&#8943;</button>
        <div class="toolbar-menu" id="toolbarMenu">
          <button onclick="exportConversation();closeToolbarMenu()">&#8615; Export chat (JSON)</button>
          <button onclick="exportMarkdown();closeToolbarMenu()">&#128221; Export as Markdown</button>
          <button onclick="exportAllConversations();closeToolbarMenu()">&#8659; Export all chats</button>
          <button onclick="document.getElementById('importInput').click();closeToolbarMenu()">&#8613; Import chat</button>
          <button onclick="openFileSearch();closeToolbarMenu()">&#128270; Search files</button>
          <button onclick="openSummaryModal();closeToolbarMenu()">&#128220; Conversation summary</button>
          <button onclick="openStatusPanel();closeToolbarMenu()">&#9888; Status / diagnostics</button>
          <button onclick="clearChat();closeToolbarMenu()">&#128465; Clear chat</button>
          <button onclick="enterSelectMode();closeToolbarMenu()">&#128247; Screenshot messages</button>
        </div>
      </div>
      <input type="file" id="importInput" accept=".json" style="display:none" onchange="importConversation(event)">
      <button class="toolbar-btn" id="charInfoBtn" onclick="showCharacterInfo()" title="Character info" aria-label="Character info" style="display:none">&#8505;</button>
      <button class="toolbar-btn" onclick="openSettings()" title="Settings" aria-label="Settings">&#9881;</button>
      <button class="toolbar-btn" id="themeToggle" onclick="toggleTheme()" title="Theme: dark" aria-label="Toggle theme">&#9790;</button>
    </div>
  </div>

  <!-- Chat search bar -->
  <div class="chat-search-bar" id="chatSearchBar">
    <input type="text" id="chatSearchInput" placeholder="Search in chat..." oninput="debouncedChatSearch()">
    <span class="search-count" id="chatSearchCount"></span>
    <button onclick="navigateChatSearch(-1)" title="Previous" aria-label="Previous search result">&#9650;</button>
    <button onclick="navigateChatSearch(1)" title="Next" aria-label="Next search result">&#9660;</button>
    <button onclick="closeChatSearch()" title="Close" aria-label="Close search">&times;</button>
  </div>

  <!-- Messages -->
  <div class="messages-area" id="messagesArea">
    <div class="chat-placeholder">Start a conversation...</div>
  </div>
  <button class="scroll-fab" id="scrollFab" onclick="document.getElementById('messagesArea').scrollTo({top:document.getElementById('messagesArea').scrollHeight,behavior:'smooth'})" title="Scroll to bottom" aria-label="Scroll to bottom">&#8595;</button>
  <div class="select-toolbar" id="selectToolbar">
    <span class="select-count" id="selectCount">0 selected</span>
    <button class="ss-btn" id="ssBtn" onclick="screenshotSelected()" disabled>Screenshot</button>
    <button class="ss-cancel" onclick="exitSelectMode()">Cancel</button>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="image-preview" id="imagePreview"></div>
    <div class="model-override-badge" id="modelOverrideBadge">
      <span id="modelOverrideText"></span>
      <button onclick="clearModelOverride()" title="Clear override">&times;</button>
    </div>
    <div class="input-row" style="position:relative">
      <div class="mention-dropdown" id="mentionDropdown"></div>
      <button class="input-btn" onclick="document.getElementById('fileInput').click()" title="Attach file" aria-label="Attach file">&#128206;</button>
      <input type="file" id="fileInput" accept="image/*,.pdf,.txt,.csv,.html,.md" multiple style="display:none" onchange="handleFileSelect(event)">
      <textarea id="chatInput" placeholder="Type a message..." rows="1"></textarea>
      <button class="input-btn" id="voiceBtn" onclick="toggleVoice()" title="Voice input" aria-label="Voice input">&#127908;</button>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" aria-label="Send message">Send</button>
    </div>
    <div class="token-info" id="tokenInfo"></div>
  </div>
</div>

<!-- Setup Modal -->
<div class="modal-overlay" id="setupModal" aria-hidden="true">
  <div class="modal" aria-labelledby="setupModalTitle">
    <h2 id="setupModalTitle">Welcome to Synapse</h2>
    <p style="color:var(--text-secondary);font-size:0.9em;margin-bottom:20px">Enter your API settings to get started. Your keys are stored locally and never sent to any server except your configured proxy.</p>
    <label>Base URL</label>
    <input type="text" id="setupProxy" placeholder="https://api.openai.com/v1">
    <label>API Key</label>
    <input type="password" id="setupKey" placeholder="sk-...">
    <label>Model</label>
    <div class="model-selector-row">
      <select id="setupModelSelect" onchange="document.getElementById('setupModelManual').value=''"><option value="">-- Fetch models first --</option></select>
      <button class="model-refresh-btn" onclick="refreshModels('setup', this)" title="Refresh model list">&#x1F504;</button>
    </div>
    <input type="text" id="setupModelManual" placeholder="Or type model name manually" value="gpt-4o" oninput="document.getElementById('setupModelSelect').value=''">
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveSetup()">Get Started</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal" aria-hidden="true">
  <div class="modal" aria-labelledby="settingsModalTitle">
    <h2 id="settingsModalTitle">Settings</h2>

    <div class="settings-tabs">
      <button class="settings-tab active" onclick="switchSettingsTab('api', this)">API</button>
      <button class="settings-tab" onclick="switchSettingsTab('prompts', this)">Prompts</button>
      <button class="settings-tab" onclick="switchSettingsTab('appearance', this)">Appearance</button>
      <button class="settings-tab" onclick="switchSettingsTab('tools', this)">Tools</button>
    </div>

    <div class="settings-tab-content active" id="settingsTab-api">
      <label>Base URL</label>
      <input type="text" id="setProxy" placeholder="https://api.openai.com/v1">
      <label>API Key</label>
      <input type="password" id="setKey">
      <label>Model</label>
      <div class="model-selector-row">
        <select id="setModelSelect" onchange="document.getElementById('setModelManual').value=''"><option value="">-- Fetch models first --</option></select>
        <button class="model-refresh-btn" onclick="refreshModels('settings', this)" title="Refresh model list">&#x1F504;</button>
      </div>
      <input type="text" id="setModelManual" placeholder="Or type model name manually" oninput="document.getElementById('setModelSelect').value=''">
      <div class="modal-section">Profiles</div>
      <label>Profile</label>
      <div class="model-selector-row">
        <select id="profileSelect" onchange="applyProfileFromSelect()"><option value="">-- Select profile --</option></select>
        <button class="model-refresh-btn" onclick="saveCurrentAsProfile()" title="Save profile">&#128190;</button>
        <button class="model-refresh-btn" onclick="deleteSelectedProfile()" title="Delete profile">&#128465;</button>
      </div>
      <input type="text" id="profileName" placeholder="New profile name">
      <label>API Format</label>
      <select id="setApiFormat">
        <option value="auto">Auto-detect</option>
        <option value="openai">OpenAI</option>
        <option value="anthropic">Anthropic</option>
      </select>
      <div class="modal-section">Request Parameters</div>
      <label class="toggle-row">
        <input type="checkbox" id="setStreaming" checked> Streaming
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="setEnterSend" checked> Enter sends message
        <span class="toggle-hint">Ctrl+Enter if off</span>
      </label>
      <label>Temperature</label>
      <input type="number" id="setTemperature" step="0.1" min="0" max="2" placeholder="e.g. 0.7 (leave empty for default)">
      <label>Extra Parameters (JSON)</label>
      <textarea id="setExtraParams" placeholder='{"temperature": 0.7, "max_tokens": 4096}'></textarea>
      <label>Exclude Parameters (comma-separated)</label>
      <input type="text" id="setExcludeParams" placeholder="e.g. stream,model">
      <label>Assistant Prefill</label>
      <input type="text" id="setPrefill" placeholder="e.g. Sure! Here's">
    </div>

    <div class="settings-tab-content" id="settingsTab-prompts">
      <label>Preset</label>
      <div class="model-selector-row">
        <select id="setPresetSelect" onchange="applyPreset(this.value)">
          <option value="">-- Custom --</option>
        </select>
        <button class="model-refresh-btn" onclick="saveCurrentAsPreset()" title="Save as preset">&#128190;</button>
        <button class="model-refresh-btn" onclick="deleteSelectedPreset()" title="Delete preset">&#128465;</button>
        <button class="model-refresh-btn" onclick="document.getElementById('stPresetFile').click()" title="Import SillyTavern preset">&#128228;</button>
        <input type="file" id="stPresetFile" accept=".json" style="display:none" onchange="importSTPreset(event)">
      </div>
      <label for="setPersona">Persona</label>
      <small style="opacity:.7;margin-bottom:4px;display:block">Describes who you (the user) are. Sent as context to the assistant.</small>
      <textarea id="setPersona" rows="3" placeholder="e.g. I am a traveling merchant named Kael…"></textarea>
      <label style="display:flex;align-items:center;justify-content:space-between">
        Prompt Entries
        <button class="model-refresh-btn" onclick="addPromptEntry()" title="Add prompt entry">+</button>
      </label>
      <div id="promptEntryList" class="prompt-entry-list"></div>
    </div>

    <div class="settings-tab-content" id="settingsTab-appearance">
    <label>Theme</label>
    <select id="setTheme" onchange="onThemeSelectChange()">
      <option value="system">System (Auto)</option>
      <optgroup label="Classic">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="nord">Nord</option>
        <option value="catppuccin">Catppuccin</option>
        <option value="dracula">Dracula</option>
        <option value="gruvbox">Gruvbox</option>
        <option value="tokyonight">Tokyo Night</option>
        <option value="solarized">Solarized</option>
        <option value="onedark">One Dark</option>
        <option value="rosepine">Rose Pine</option>
        <option value="claude">Claude</option>
        <option value="claudeDark">Claude Dark</option>
      </optgroup>
        <option value="monochrome">Monochrome</option>
        <option value="pewter">Pewter</option>
        <option value="deepSea">Deep Sea</option>
        <option value="gunmetal">Gunmetal</option>
        <option value="clearSky">Clear Sky</option>
        <option value="cobalt">Cobalt</option>
        <option value="nightshade">Nightshade</option>
        <option value="plumWine">Plum Wine</option>
        <option value="neonDusk">Neon Dusk</option>
        <option value="lavenderHaze">Lavender Haze</option>
        <option value="jadeMist">Jade Mist</option>
        <option value="mossStone">Moss Stone</option>
        <option value="emeraldForest">Emerald Forest</option>
        <option value="winterBreeze">Winter Breeze</option>
        <option value="neonNoir">Neon Noir</option>
        <option value="hotPink">Hot Pink</option>
        <option value="roseQuartz">Rose Quartz</option>
        <option value="ember">Ember</option>
        <option value="moltenCore">Molten Core</option>
        <option value="orchidTeal">Orchid Teal</option>
        <option value="acidGlow">Acid Glow</option>
        <option value="fjord">Fjord</option>
        <option value="oxide">Oxide</option>
        <option value="blueprint">Blueprint</option>
        <option value="paperInk">Paper &amp; Ink</option>
        <option value="moss">Moss</option>
      <option value="custom">Custom</option>
    </select>
    <div class="theme-colors" id="customThemeColors" style="display:none">
      <div class="theme-color-item"><input type="color" id="cBg" oninput="liveCustomTheme()"><span>Background</span></div>
      <div class="theme-color-item"><input type="color" id="cSidebar" oninput="liveCustomTheme()"><span>Sidebar</span></div>
      <div class="theme-color-item"><input type="color" id="cBorder" oninput="liveCustomTheme()"><span>Border</span></div>
      <div class="theme-color-item"><input type="color" id="cText" oninput="liveCustomTheme()"><span>Text</span></div>
      <div class="theme-color-item"><input type="color" id="cTextSec" oninput="liveCustomTheme()"><span>Text Secondary</span></div>
      <div class="theme-color-item"><input type="color" id="cAccent" oninput="liveCustomTheme()"><span>Accent</span></div>
      <div class="theme-color-item"><input type="color" id="cAccentHover" oninput="liveCustomTheme()"><span>Accent Hover</span></div>
      <div class="theme-color-item"><input type="color" id="cMsgUser" oninput="liveCustomTheme()"><span>User Bubble</span></div>
      <div class="theme-color-item"><input type="color" id="cMsgAssistant" oninput="liveCustomTheme()"><span>Assistant Bubble</span></div>
      <div class="theme-color-item"><input type="text" id="cBorderRadius" oninput="liveCustomTheme()" placeholder="16px" style="width:60px"><span>Radius</span></div>
      <div class="theme-color-item"><input type="text" id="cMsgMaxWidth" oninput="liveCustomTheme()" placeholder="75%" style="width:60px"><span>Msg Width</span></div>
      <div class="theme-color-item"><input type="text" id="cMsgFontSize" oninput="liveCustomTheme()" placeholder="0.95em" style="width:60px"><span>Font Size</span></div>
      <div class="theme-color-item"><input type="color" id="cCodeBg" oninput="liveCustomTheme()"><span>Code BG</span></div>
      <div class="theme-color-item" style="grid-column: 1 / -1">
        <button onclick="resetCustomTheme()" style="width:100%;padding:6px;cursor:pointer">Clear custom theme</button>
      </div>
    </div>
    <label>Font</label>
    <input type="text" id="setFont" placeholder="e.g. Inter, Poppins, JetBrains Mono">
    <label>Message Font Size</label>
    <input type="text" id="setMsgFontSize" placeholder="0.95em (default)">
    <label>Message Width</label>
    <input type="text" id="setMsgMaxWidth" placeholder="75% (default)">
    </div>

    <div class="settings-tab-content" id="settingsTab-tools">
    <label class="toggle-row">
      <input type="checkbox" id="setWebSearch"> Web Search
      <span class="toggle-hint">Anthropic native · OpenAI via search API</span>
    </label>
    <label class="toggle-row">
      <input type="checkbox" id="setForceSearch"> Force tool use
      <span class="toggle-hint">Always call tools · prevents hallucinating answers</span>
    </label>
    <label>Search API URL <span class="toggle-hint">SearXNG, Brave, or custom with {query}/{key}</span></label>
    <input type="text" id="setSearchApiUrl" placeholder="https://purasearx.duckdns.org/search?format=json">
    <label>Search API Key <span class="toggle-hint">optional for SearXNG · required for Brave · supports Header: value</span></label>
    <input type="password" id="setSearchApiKey" placeholder="token or X-API-Key: value">
    <label>CORS Proxy URL <span class="toggle-hint">prefix for cross-origin requests</span></label>
    <input type="text" id="setCorsProxy" placeholder="https://corsproxy.io/?url=">
    <button class="btn btn-secondary" style="width:100%;padding:8px;font-size:0.8em;margin-bottom:14px" onclick="openSearchTest()">Test Search</button>
    <label class="toggle-row">
      <input type="checkbox" id="setMemory"> Memory
      <span class="toggle-hint">Remember info across chats</span>
    </label>
    <button class="btn btn-secondary" style="width:100%;padding:8px;font-size:0.8em;margin-bottom:14px" onclick="openManageMemories()">Manage Memories</button>
    <label class="toggle-row">
      <input type="checkbox" id="setHoldScreenshot"> Hold to Screenshot
      <span class="toggle-hint">Long-press messages to screenshot</span>
    </label>

    <div class="modal-section">Cost Tracking</div>
    <label>Input Cost per 1M tokens</label>
    <input type="number" id="setInputCost" step="0.01" placeholder="e.g. 2.50">
    <label>Output Cost per 1M tokens</label>
    <input type="number" id="setOutputCost" step="0.01" placeholder="e.g. 10.00">
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal-overlay" id="shortcutsModal" aria-hidden="true">
  <div class="modal" style="max-width:480px" aria-labelledby="shortcutsModalTitle">
    <h2 id="shortcutsModalTitle">Keyboard Shortcuts</h2>
    <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 16px;font-size:0.85em">
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Enter</kbd><span>Send message (configurable)</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Shift+Enter</kbd><span>New line in input</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Ctrl+Enter</kbd><span>Always sends message</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Ctrl+N</kbd><span>New conversation</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Ctrl+/</kbd><span>Focus input</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Ctrl+K</kbd><span>Search conversations</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Ctrl+F</kbd><span>Search in current chat</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Ctrl+Shift+E</kbd><span>Export all conversations</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Ctrl+Shift+R</kbd><span>Regenerate last response</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Escape</kbd><span>Close modal / Stop streaming</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">Ctrl+Shift+?</kbd><span>Show this help</span>
      <kbd style="background:var(--hover);padding:2px 8px;border-radius:4px;font-family:inherit;white-space:nowrap">@model</kbd><span>Override model for one message</span>
    </div>
    <div class="modal-actions" style="margin-top:16px">
      <button class="btn btn-primary" onclick="closeModal('shortcutsModal')">Close</button>
    </div>
  </div>
</div>

<script type="module" src="./js/main.js"></script>
</body>
</html>
